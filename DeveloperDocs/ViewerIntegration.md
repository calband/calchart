# CalChart Viewer Integration

The CalChart viewer is integrated as a Git submodule at `viewer/`.

## Preview in Viewer (Modal Dialog)

The viewer is integrated as a **modal preview dialog**, similar in spirit to a print preview. It does **not** live in the center pane or participate in the Cmd+Return cycling.

- **Cmd+Return** continues to cycle **Field ↔ Animation** only.
- **View > Preview in Viewer (experimental)...** opens a modal dialog that embeds the viewer.
- The dialog can be dismissed via **Esc**, the window close button, or the **Close** button.

This keeps the viewer isolated as a preview tool and avoids maintaining live editor state while the user is working in the main app.

### Implementation

The modal preview is implemented in [ViewerPreviewDialog.h](../src/ViewerPreviewDialog.h) and [ViewerPreviewDialog.cpp](../src/ViewerPreviewDialog.cpp):

- **`ViewerPreviewDialog`** - A `wxDialog` that hosts a `ViewerPanel`
- **`OnToggleViewerPanel()`** - Menu handler that opens the modal dialog

The center view system remains only **Field** and **Animation** (see [CalChartFrame.h](../src/CalChartFrame.h) and [CalChartFrame.cpp](../src/CalChartFrame.cpp)).

## Architecture

### HTTP Server (ViewerServer)

CalChart runs an embedded HTTP server ([ViewerServer.cpp](../src/ViewerServer.cpp)) on port 1868 that:

- Serves the viewer HTML/CSS/JS to the embedded wxWebView browser
- Provides a REST API at `/api/show` that returns the current show as JSON
- Provides a health check endpoint at `/api/status`

**Debug vs Release behavior:**
- **Debug builds**: Serve files directly from `viewer/` directory for live editing (using `CMAKE_VIEWER_SOURCE_DIR`)
- **Release builds**: Serve pre-embedded HTML from the binary (generated by [cmake/EmbedViewerHtml.cmake](../cmake/EmbedViewerHtml.cmake))

This gives developers the flexibility to edit viewer HTML/CSS/JS and see changes immediately by refreshing the browser, while maintaining the convenience of a single-binary deployment.

**Important:** The debug file serving uses explicit file routes with regex patterns instead of httplib's `set_mount_point()` to avoid AddressSanitizer (ASAN) crashes in httplib's conditional request handling.

### ViewerPanel

[ViewerPanel.cpp](../src/ViewerPanel.cpp) is a wxPanel that embeds a wxWebView browser:

- **`GoHome()`** - Navigates to `http://localhost:1868`
- **`UpdateShowData()`** - Calls JavaScript `loadCalChartShow()` to refresh show data without page reload (queued until page load if needed)
- **`RefreshViewer()`** - Full page reload (rarely used, UpdateShowData preferred)
- **`OnPageLoaded()`** - Triggered when page finishes loading, calls UpdateShowData to load initial show
- **`InjectShowData(json)`** - Overrides `/api/show` response with provided JSON and then calls `UpdateShowData()`

### JavaScript Integration

The viewer's JavaScript ([viewer/js/](../viewer/js/)) is modified to support CalChart integration:

**[viewer/js/viewer/ApplicationController.js](../viewer/js/viewer/ApplicationController.js):**
```javascript
ApplicationController.prototype.loadFromCalChart = function() {
    $.ajax({
        url: '/api/show',
        dataType: 'json',
        success: function(data) {
            var show = ShowUtils.fromJSON(data);
            // ... load show into viewer
        }
    });
};
```

**[viewer/js/application.js](../viewer/js/application.js):**
```javascript
// Expose function for CalChart to call via RunScript()
window.loadCalChartShow = function() {
    applicationController.loadFromCalChart();
};
```

### Injecting Show Data (Advanced)

`InjectShowData()` is intended for previewing data that is not the current document (e.g., loading a `.viewer` file without modifying the open show).

**How it works:**
1. CalChart stores the provided JSON on the embedded HTTP server as an override for `/api/show`.
2. `UpdateShowData()` is called, which triggers `loadCalChartShow()`.
3. The viewer fetches `/api/show` and receives the injected JSON.

This avoids sending huge JSON strings through `RunScript()` and is more reliable on WebKit backends.

**Example usage (from current document):**
```cpp
if (mDoc && mViewerPanel) {
    auto json = mDoc->toViewerJSON();
    mViewerPanel->InjectShowData(json.dump());
}
```

**Example usage (from file):**
```cpp
std::ifstream file(filepath);
std::string jsonData((std::istreambuf_iterator<char>(file)), std::istreambuf_iterator<char>());
mViewerPanel->InjectShowData(jsonData);
```

### Auto-Update on Edits

The viewer preview **does not** auto-update on every edit. It is intended as a preview-only surface and updates its data when the dialog is opened (and when `UpdateShowData()` is explicitly invoked). This avoids live state synchronization while the user is editing.

## Build System

The embedding is handled by:

1. **cmake/EmbedViewerHtml.cmake** - CMake function that reads `viewer/index.html` and generates `CalChartViewerHtml.h`
2. **src/CMakeLists.txt** - Calls `embed_viewer_html()` and adds the generated header to the CalChart target
3. **ViewerServer.cpp** - Uses `CalChart::ViewerHtml::GetViewerHtml()` to get the HTML content

## Development Workflow

### Initial Setup

When cloning the repository:

```bash
git submodule update --init --recursive
```

**The viewer is built automatically by CMake!** If you have Node.js installed, CMake will:
1. Run `npm install` to install dependencies (if needed)
2. Run `grunt build` to compile JavaScript and CSS
3. Create the viewer assets in `viewer/build/`

No manual setup required - just configure and build as normal!

### Building the Viewer

The viewer build is integrated into CMake and happens automatically during configuration/build.

**What CMake does:**
- Checks for Node.js and npm
- Installs npm dependencies (creates `viewer/node_modules/`)
- Builds JavaScript (`viewer/build/js/application.js`)
- Builds CSS (`viewer/build/css/app.css`, `graph.css`, etc.)

**Manual build (if needed):**
```bash
cd viewer
npm install
npm run build
```

Or use the convenience script:
```bash
./scripts/setup-viewer.sh
```

### Editing the Viewer

In debug builds, all viewer files (HTML, CSS, JS, images) are served directly from the `viewer/` directory.

**For active development:**

1. In one terminal, run the viewer's auto-rebuild:
   ```bash
   cd viewer
   npm run watch
   ```
   This will automatically rebuild JS/CSS when you edit files.

2. Run CalChart in debug mode
3. Enable the viewer: **Preferences > General Setup > Enable Viewer (experimental)**
4. Switch to Viewer mode (Cmd+Return until you reach viewer, or **View > Preview in Viewer (experimental)...**)
5. Edit viewer files - the browser will automatically refresh via the viewer's built-in refresh mechanism
6. Make changes to CalChart - the viewer updates automatically via `UpdateShowData()`

**What gets served in debug:**
- `/` → `viewer/index.html`
- `/build/js/application.js` → `viewer/build/js/application.js`
- `/build/css/app.css` → `viewer/build/css/app.css`
- `/img/*` → `viewer/img/*`
- All other static assets from `viewer/`

### Testing Release Mode

To test the embedded version (what end users will see):

```bash
cd build/mac-release
cmake -DCMAKE_BUILD_TYPE=Release ../..
cmake --build .
```

Release builds embed the HTML at compile time, so you need to rebuild after viewer changes.

## Implementation Details

The generated header (`build/*/src/generated/CalChartViewerHtml.h`) contains:

- `GetEmbeddedHtml()` - Returns the pre-embedded HTML string
- `GetViewerHtml()` - Smart function that:
  - In debug: Reads from `CMAKE_VIEWER_SOURCE_DIR/index.html` if available
  - Falls back to embedded HTML if file read fails or in release mode

The `CMAKE_VIEWER_SOURCE_DIR` preprocessor define is only set in Debug builds, making the filesystem path available.

## Key Implementation Details

### ASAN Fix for Static File Serving

The debug build originally used httplib's `set_mount_point()` feature to serve static files, but this caused **AddressSanitizer (ASAN) buffer overflow crashes** when handling HTTP conditional requests (If-None-Match headers).

**Solution:** Implemented explicit file serving with regex routes ([ViewerServer.cpp lines 98-127](../src/ViewerServer.cpp)):
```cpp
#ifdef CMAKE_VIEWER_SOURCE_DIR
mServer->Get(R"(.+\.(css|js|png|jpg|jpeg|gif|svg|ico|json|woff|woff2|ttf|eot))", 
    [](const httplib::Request& req, httplib::Response& res) {
    auto path = std::string(CMAKE_VIEWER_SOURCE_DIR) + req.path;
    std::ifstream file(path, std::ios::binary);
    // ... manual file reading and Content-Type setting ...
});
#endif
```

This avoids the buggy code path entirely while maintaining live file serving for development.

### Data Flow

**CalChart → Viewer:**
1. User edits show in CalChart
2. `CalChartFrame::OnUpdate()` called
3. If viewer visible: `mViewerPanel->UpdateShowData()`
4. wxWebView executes: `window.loadCalChartShow()`
5. JavaScript calls AJAX: `GET http://localhost:1868/api/show`
6. ViewerServer calls: `CalChartDoc::toViewerJSON()`
7. Viewer receives JSON and calls: `ShowUtils.fromJSON(data)`
8. Viewer re-renders with updated show

**No page reloads needed** - the viewer updates its data model in-place, providing smooth live editing experience.

## Future Enhancements

Possible improvements:

1. **~~Static asset serving~~** - ✅ **DONE** - Debug mode serves CSS/JS/images from `viewer/` directory
2. **Multiple file embedding** - Embed all viewer assets (CSS, JS) for offline use in release builds
3. **Build-time optimization** - Minify HTML/CSS/JS for release builds
4. **~~Auto-refresh on edits~~** - ✅ **DONE** - Viewer updates automatically when show is edited
5. **Configuration UI** - Add viewer-specific settings (refresh rate, layout options)
6. **Error handling** - Better UI feedback when viewer fails to load
7. **Remove experimental label** - Once stable, drop the “experimental” wording from the preview menu

## Updating the Viewer Submodule

To update to the latest viewer version:

```bash
cd viewer
git checkout main  # or specific branch/tag
git pull
cd ..
git add viewer
git commit -m "Update viewer submodule to latest"
```

Or to update to a specific commit:

```bash
cd viewer
git checkout <commit-hash>
cd ..
git add viewer
git commit -m "Update viewer submodule to <commit-hash>"
```
