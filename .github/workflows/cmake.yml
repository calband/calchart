# much of this inspired from: https://cristianadam.eu/20191222/using-github-actions-with-c-plus-plus-and-cmake/
# and also the excellent series from:
# https://www.edwardthomson.com/blog/github_actions_advent_calendar.html
name: CI action for CalChart

on:
  push:
    branches: [main, calchart-3.6]
    tags: ['*']
  pull_request:
    branches: [main, calchart-3.6]

jobs:
  build:
    name: ${{ matrix.config.name }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
        - {
            name: "Ubuntu Latest GCC",
            artifact: "CalChart.tar.xz",
            artifact_name: "CalChart-Linux",
            os: ubuntu-24.04,
          }
        - {
            name: "macOS 14 Clang",
            artifact: "CalChart-*.dmg",
            artifact_name: "CalChart-macOS",
            os: macos-14,
          }
        - {
            name: "Windows Latest MSVC",
            artifact: "CalChart-*.exe",
            artifact_name: "CalChart-Windows",
            os: windows-latest,
          }
        build_type: [Debug, Release]
        exclude:
          - config: {os: windows-latest}
            build_type: Debug

    steps:
    - name: Free disk space (Linux)
      if: matrix.config.os == 'ubuntu-24.04'
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Get vcpkg baseline
      id: vcpkg-baseline
      run: |
        BASELINE=$(grep -o '"builtin-baseline": "[^"]*"' vcpkg.json | cut -d'"' -f4)
        echo "hash=$BASELINE" >> $GITHUB_OUTPUT
      shell: bash

    - name: Cache vcpkg
      id: cache-vcpkg
      uses: actions/cache@v4
      with:
        path: ${{github.workspace}}/vcpkg
        key: vcpkg-install-${{ runner.os }}-${{ steps.vcpkg-baseline.outputs.hash }}

    - name: Setup vcpkg
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/microsoft/vcpkg.git "$GITHUB_WORKSPACE/vcpkg"
        cd "$GITHUB_WORKSPACE/vcpkg"
        git checkout ${{ steps.vcpkg-baseline.outputs.hash }}
        if [ "$RUNNER_OS" == "Windows" ]; then
          ./bootstrap-vcpkg.bat
        else
          ./bootstrap-vcpkg.sh
        fi
      shell: bash

    - name: Cache vcpkg binary cache
      uses: actions/cache@v4
      with:
        path: ${{github.workspace}}/vcpkg-cache
        key: vcpkg-archives-${{ runner.os }}-${{ runner.arch }}-${{ matrix.build_type }}-${{ hashFiles('vcpkg.json') }}-${{ steps.vcpkg-baseline.outputs.hash }}
        restore-keys: |
          vcpkg-archives-${{ runner.os }}-${{ runner.arch }}-${{ matrix.build_type }}-

    - name: Install Xcode (macOS)
      if: matrix.config.os == 'macos-14'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'

    - name: Install Dependencies (macOS)
      if: matrix.config.os == 'macos-14'
      run: brew install pandoc

    - name: Install Dependencies (Windows)
      if: matrix.config.os == 'windows-latest'
      run: |
        choco install -y winflexbison nsis curl openssl.light pkgconfiglite git pandoc
        echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
        nuget install Microsoft.Web.WebView2 -OutputDirectory "${{ github.workspace }}\packages"
        Get-ChildItem "${{ github.workspace }}\packages" -Filter "Microsoft.Web.WebView2*" -Directory | ForEach-Object {
          $x64Path = Join-Path $_.FullName "build\native\x64"
          if (Test-Path $x64Path) {
            echo "WEBVIEW2_LIB_PATH=$x64Path" >> $env:GITHUB_ENV
          }
        }

    - name: Install Dependencies (Linux)
      if: matrix.config.os == 'ubuntu-24.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y autoconf autoconf-archive automake libltdl-dev \
          build-essential libgtk-3-dev libcurl4-openssl-dev pkg-config ninja-build \
          bison flex zip unzip tar curl pandoc
        sudo apt install -y gcc-14 g++-14
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 \
          --slave /usr/bin/g++ g++ /usr/bin/g++-14 --slave /usr/bin/gcov gcov /usr/bin/gcov-14

    # Configure & Build
    - name: Configure CMake (Windows)
      if: matrix.config.os == 'windows-latest'
      env:
        VCPKG_BINARY_SOURCES: 'clear;files,${{github.workspace}}/vcpkg-cache,readwrite'
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{matrix.build_type}} -DCMAKE_POLICY_DEFAULT_CMP0091=NEW -DCMAKE_MSVC_RUNTIME_LIBRARY="MultiThreaded$<$<CONFIG:Debug>:Debug>" -DCMAKE_TOOLCHAIN_FILE="${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows-static -DWEBVIEW2_LIB_PATH="${{env.WEBVIEW2_LIB_PATH}}"

    - name: Configure CMake (macOS/Linux)
      if: matrix.config.os != 'windows-latest'
      env:
        VCPKG_BINARY_SOURCES: 'clear;files,${{github.workspace}}/vcpkg-cache,readwrite'
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{matrix.build_type}} -DCMAKE_TOOLCHAIN_FILE="${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake"

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{matrix.build_type}}

    - name: Test
      run: ctest --verbose --test-dir ${{github.workspace}}/build

    # Packaging
    - name: Package (macOS - initial)
      if: matrix.config.os == 'macos-14'
      run: pushd ${{github.workspace}}/build && cpack -G DragNDrop

    - name: Package (Windows)
      if: matrix.config.os == 'windows-latest'
      run: |
        $cmdpath = split-path -parent (get-command cmake).Path
        $cpack_cmd = Join-Path -Path $cmdpath -ChildPath cpack
        pushd ${{github.workspace}}/build
        & $cpack_cmd

    - name: Package (Linux)
      if: matrix.config.os == 'ubuntu-24.04'
      run: |
        cmake --install build --prefix instdir --strip
        cd instdir && cmake -E tar cJfv ${{github.workspace}}/build/CalChart.tar.xz .

    # macOS Codesigning (see DeveloperDocs/MacOSCodesigning.md for setup instructions)
    - name: Setup Keychain (macOS)
      if: matrix.config.os == 'macos-14' && matrix.build_type == 'Release'
      env:
        MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
        MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
      run: |
        echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
        security create-keychain -p "CalChart" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "CalChart" build.keychain
        security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "CalChart" build.keychain

    - name: Sign and Notarize (macOS)
      if: matrix.config.os == 'macos-14' && matrix.build_type == 'Release'
      env:
        DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
      run: |
        # Extract DMG, sign app, repackage
        ORIGINAL_DMG=$(find build -name "CalChart-*.dmg" -print -quit)
        hdiutil convert "$ORIGINAL_DMG" -format UDRW -o build/CalChart_rw.dmg
        hdiutil attach build/CalChart_rw.dmg -mountpoint /Volumes/CalChart -nobrowse -noverify
        
        cp -R /Volumes/CalChart/CalChart.app build/CalChart_temp.app
        codesign --deep --force --verify --verbose --timestamp --options runtime \
          --entitlements resources/macos/CalChart.entitlements \
          --sign "$DEVELOPER_ID_APP" build/CalChart_temp.app
        
        # Notarize app bundle
        ditto -c -k --keepParent build/CalChart_temp.app build/CalChart.zip
        xcrun notarytool submit build/CalChart.zip \
          --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" \
          --password "$APP_SPECIFIC_PASSWORD" --wait
        xcrun stapler staple build/CalChart_temp.app
        
        # Repack DMG
        rm -rf /Volumes/CalChart/CalChart.app
        cp -R build/CalChart_temp.app /Volumes/CalChart/CalChart.app
        hdiutil detach /Volumes/CalChart
        rm "$ORIGINAL_DMG"
        hdiutil convert build/CalChart_rw.dmg -format UDZO -o "$ORIGINAL_DMG"
        
        # Sign and notarize DMG
        codesign --force --sign "$DEVELOPER_ID_APP" --timestamp --options runtime "$ORIGINAL_DMG"
        SUBMISSION_OUTPUT=$(xcrun notarytool submit "$ORIGINAL_DMG" \
          --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" \
          --password "$APP_SPECIFIC_PASSWORD" --wait --output-format json)
        
        STATUS=$(echo "$SUBMISSION_OUTPUT" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
        if [ "$STATUS" != "Accepted" ]; then
          echo "Notarization failed: $STATUS"
          exit 1
        fi
        
        xcrun stapler staple "$ORIGINAL_DMG"

    - name: Upload Artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        path: ${{github.workspace}}/build/${{ matrix.config.artifact }}
        name: ${{ matrix.config.artifact_name }}

  release:
    if: contains(github.ref, 'tags/v')
    name: Release
    runs-on: ubuntu-24.04
    needs: build
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: CalChart-*/*
        bodyFile: ./LATEST_RELEASE_NOTES.md
        draft: true
        token: ${{ secrets.GITHUB_TOKEN }}
