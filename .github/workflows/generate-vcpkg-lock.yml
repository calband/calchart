name: Generate vcpkg lockfile

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-lock:
    name: Generate vcpkg-lock.json (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone & bootstrap vcpkg
        run: |
          # Clone the vcpkg repo and ensure we use a recent upstream commit that
          # supports lockfile generation. We'll try to checkout origin/main then
          # fallback to origin/master.
          git clone https://github.com/microsoft/vcpkg.git vcpkg
          pushd vcpkg
          git fetch --all --tags
          if (git show-ref --verify --quiet refs/remotes/origin/main) {
            git checkout origin/main
          } else {
            git checkout origin/master
          }
          popd
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Debug vcpkg and workspace
        run: |
          .\vcpkg\vcpkg.exe version || true
          dir
          type vcpkg.json || echo "vcpkg.json not found"

      - name: Install ports (manifest auto-detect)
        run: |
          # Some vcpkg builds don't accept a --manifest switch; plain 'install' will
          # auto-detect the top-level vcpkg.json when run from the repo root.
          .\vcpkg\vcpkg.exe install --triplet x64-windows-static

      - name: Ensure lockfile is at repo root
        run: |
          if (Test-Path vcpkg-lock.json) {
            Write-Host "vcpkg-lock.json already at repo root"
          } elseif (Test-Path vcpkg\vcpkg-lock.json) {
            Move-Item vcpkg\vcpkg-lock.json vcpkg-lock.json
            Write-Host "Moved vcpkg\vcpkg-lock.json -> vcpkg-lock.json"
          } else {
            Write-Host "No lockfile found; vcpkg may not have generated one"
            Exit 0
          }

      - name: Create branch and push lockfile
        env:
          BRANCH_NAME: add/vcpkg-lock-${{ github.run_id }}
        run: |
          git checkout -b %BRANCH_NAME%
          git add vcpkg-lock.json
          git commit -m "Add vcpkg-lock.json"
          git push --set-upstream origin %BRANCH_NAME%

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: add/vcpkg-lock-${{ github.run_id }}
          base: main
          title: Add vcpkg-lock.json
          body: |
            This PR was automatically generated by CI to add a vcpkg-lock.json
            generated on a Windows runner so that vcpkg port versions are pinned
            for reproducible Windows builds.
