name: Generate vcpkg lockfile

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-lock:
    name: Generate vcpkg-lock.json (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone & bootstrap vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git vcpkg
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Install manifest ports and attempt to generate lockfile
        run: |
          .\vcpkg\vcpkg.exe install --triplet x64-windows-static --manifest

      - name: Ensure lockfile is at repo root
        run: |
          if (Test-Path vcpkg-lock.json) {
            Write-Host "vcpkg-lock.json already at repo root"
          } elseif (Test-Path vcpkg\vcpkg-lock.json) {
            Move-Item vcpkg\vcpkg-lock.json vcpkg-lock.json
            Write-Host "Moved vcpkg\vcpkg-lock.json -> vcpkg-lock.json"
          } else {
            Write-Host "No lockfile found; vcpkg may not have generated one"
            Exit 0
          }

      - name: Create branch and push lockfile
        env:
          BRANCH_NAME: add/vcpkg-lock-${{ github.run_id }}
        run: |
          git checkout -b %BRANCH_NAME%
          git add vcpkg-lock.json
          git commit -m "Add vcpkg-lock.json"
          git push --set-upstream origin %BRANCH_NAME%

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: add/vcpkg-lock-${{ github.run_id }}
          base: main
          title: Add vcpkg-lock.json
          body: |
            This PR was automatically generated by CI to add a vcpkg-lock.json
            generated on a Windows runner so that vcpkg port versions are pinned
            for reproducible Windows builds.
